<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram Bot Control Panel</title>
    <link rel="stylesheet" href="{{.BASE_URL}}assets/styles/telegram.css" />
</head>
<body data-base-url="{{.BASE_URL}}">
    <div id="loading-backdrop" hidden>
        <div class="spinner" aria-hidden="true"></div>
        <p>Загрузка...</p>
    </div>
    <div id="toast" role="status" aria-live="polite"></div>

    <header class="page-header">
        <h1>Настройка Telegram-бота</h1>
        <nav class="page-actions">
            <a class="btn" href="{{.BASE_URL}}">⟵ Панель управления</a>
        </nav>
    </header>

    <main class="layout">
        <section class="card" id="config-section">
            <header class="section-header">
                <div>
                    <h2>Основные настройки</h2>
                    <p class="section-subtitle">
                        Управляйте доступом бота, параметрами оплаты и ссылками на приложения — подтверждение платежей выполняется автоматически.
                    </p>
                </div>
                <button class="btn primary" form="config-form" type="submit">Сохранить настройки</button>
            </header>
            <form id="config-form" class="form-grid">
                <label class="switch">
                    <span>Активировать бота</span>
                    <input type="checkbox" id="config-enabled" name="enabled" />
                    <span class="slider"></span>
                </label>

                <div class="form-field full">
                    <label for="config-bot-token">Токен бота</label>
                    <input type="password" id="config-bot-token" name="botToken" placeholder="Введите новый токен" autocomplete="off" />
                    <p class="hint" id="bot-token-mask">Токен не задан.</p>
                    <p class="hint warning">Для сохранения текущего токена и секретов введите их повторно.</p>
                </div>

                <div class="form-field">
                    <label for="config-webhook-domain">Домен вебхука</label>
                    <input type="text" id="config-webhook-domain" name="webhookDomain" placeholder="example.com" />
                </div>
                <div class="form-field">
                    <label for="config-webhook-secret">Секрет вебхука</label>
                    <input type="text" id="config-webhook-secret" name="webhookSecret" placeholder="Секрет подписи" />
                </div>

                <div class="form-field">
                    <label for="config-shop-id">YooKassa shopId</label>
                    <input type="text" id="config-shop-id" name="yooKassaShopId" placeholder="000000" />
                </div>
                <div class="form-field">
                    <label for="config-secret-key">YooKassa секретный ключ</label>
                    <input type="text" id="config-secret-key" name="yooKassaSecretKey" placeholder="секретный ключ" />
                </div>

                <fieldset class="form-field full">
                    <legend>Ссылки на скачивание</legend>
                    <p class="hint">Укажите название платформы и URL. Пустые строки будут проигнорированы.</p>
                    <table class="table" id="download-links-table">
                        <thead>
                            <tr>
                                <th>Платформа</th>
                                <th>Ссылка</th>
                                <th class="actions"></th>
                            </tr>
                        </thead>
                        <tbody id="download-links-body"></tbody>
                    </table>
                    <button type="button" id="add-download-link" class="btn subtle">Добавить ссылку</button>
                </fieldset>
            </form>
        </section>

        <section class="card" id="tariffs-section">
            <header class="section-header">
                <div>
                    <h2>Тарифы</h2>
                    <p class="section-subtitle">
                        Создавайте подписки, управлять ценой и длительностью.
                    </p>
                </div>
                <div class="section-actions">
                    <button class="btn" type="button" id="refresh-tariffs">Обновить</button>
                    <button class="btn primary" type="submit" form="tariff-form">Сохранить тариф</button>
                </div>
            </header>

            <div class="tariff-layout">
                <div class="tariff-list">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Цена</th>
                                <th>Длительность</th>
                                <th>Статус</th>
                                <th class="actions"></th>
                            </tr>
                        </thead>
                        <tbody id="tariff-table-body"></tbody>
                    </table>
                    <button class="btn subtle" type="button" id="create-tariff">Новый тариф</button>
                </div>

                <form id="tariff-form" class="form-grid">
                    <input type="hidden" id="tariff-id" name="id" />
                    <div class="form-field full">
                        <label for="tariff-title">Название</label>
                        <input type="text" id="tariff-title" name="title" required />
                    </div>
                    <div class="form-field full">
                        <label for="tariff-description">Описание</label>
                        <textarea id="tariff-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-field">
                        <label for="tariff-price">Цена (в валюте)</label>
                        <input type="number" step="0.01" min="0" id="tariff-price" name="price" required />
                    </div>
                    <div class="form-field">
                        <label for="tariff-currency">Валюта</label>
                        <input type="text" id="tariff-currency" name="currency" maxlength="8" placeholder="RUB" required />
                    </div>
                    <div class="form-field">
                        <label for="tariff-duration">Длительность (дней)</label>
                        <input type="number" min="0" id="tariff-duration" name="duration" />
                    </div>
                    <div class="form-field">
                        <label for="tariff-sort">Порядок сортировки</label>
                        <input type="number" id="tariff-sort" name="sortOrder" value="0" />
                    </div>
                    <label class="switch">
                        <span>Активен</span>
                        <input type="checkbox" id="tariff-active" name="active" />
                        <span class="slider"></span>
                    </label>
                </form>
            </div>
        </section>

        <section class="card" id="buttons-section">
            <header class="section-header">
                <div>
                    <h2>Клавиатура бота</h2>
                    <p class="section-subtitle" id="buttons-subtitle">Настройте кнопки, которые пользователи увидят прямо в чате.</p>
                </div>
                <div class="section-actions">
                    <button class="btn subtle" type="button" id="add-button">Добавить кнопку</button>
                </div>
            </header>

            <div class="button-layout">
                <div class="button-list">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Подпись</th>
                                <th>Действие</th>
                                <th>Payload</th>
                                <th class="actions"></th>
                            </tr>
                        </thead>
                        <tbody id="button-table-body"></tbody>
                    </table>
                </div>

                <form id="button-form" class="form-grid" hidden>
                    <input type="hidden" id="button-id" />
                    <input type="hidden" id="button-tariff-id" />
                    <div class="form-field full">
                        <label for="button-label">Подпись</label>
                        <input type="text" id="button-label" required />
                    </div>
                    <div class="form-field">
                        <label for="button-action">Действие</label>
                        <input type="text" id="button-action" list="button-action-suggestions" placeholder="purchase" required />
                        <datalist id="button-action-suggestions">
                            <option value="purchase"></option>
                            <option value="link"></option>
                            <option value="support"></option>
                        </datalist>
                    </div>
                    <div class="form-field full">
                        <label for="button-payload">Payload / URL</label>
                        <input type="text" id="button-payload" placeholder="Введите payload" />
                    </div>
                    <div class="form-field">
                        <label for="button-sort">Порядок сортировки</label>
                        <input type="number" id="button-sort" value="0" />
                    </div>
                    <div class="form-actions full">
                        <button type="submit" class="btn primary">Сохранить кнопку</button>
                        <button type="button" class="btn" id="cancel-button-edit">Отмена</button>
                    </div>
                </form>
            </div>
        </section>

        <section class="card" id="broadcasts-section">
            <header class="section-header">
                <div>
                    <h2>Массовые рассылки</h2>
                    <p class="section-subtitle">Создавайте сегменты пользователей и отправляйте уведомления или новости.</p>
                </div>
                <div class="section-actions">
                    <button class="btn" type="button" id="refresh-broadcasts">Обновить</button>
                    <button class="btn primary" type="submit" form="broadcast-form">Сохранить рассылку</button>
                </div>
            </header>

            <div class="broadcast-layout">
                <div class="broadcast-list">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Аудитория</th>
                                <th>Статус</th>
                                <th>Результат</th>
                                <th class="actions"></th>
                            </tr>
                        </thead>
                        <tbody id="broadcast-table-body"></tbody>
                    </table>
                    <div class="list-actions">
                        <button class="btn subtle" type="button" id="create-broadcast">Новая рассылка</button>
                    </div>
                </div>

                <form id="broadcast-form" class="form-grid">
                    <input type="hidden" id="broadcast-id" />
                    <div class="form-field full">
                        <label for="broadcast-title">Название</label>
                        <input type="text" id="broadcast-title" required />
                    </div>
                    <div class="form-field full">
                        <label for="broadcast-body">Текст сообщения</label>
                        <textarea id="broadcast-body" rows="4" required></textarea>
                    </div>
                    <label class="switch">
                        <span>Разрешить редактировать после отправки</span>
                        <input type="checkbox" id="broadcast-editable" checked />
                        <span class="slider"></span>
                    </label>
                    <fieldset class="form-field full">
                        <legend>Аудитория</legend>
                        <div class="audience-flags">
                            <label class="checkbox">
                                <input type="checkbox" id="broadcast-all-users" checked />
                                <span>Все пользователи</span>
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="broadcast-include-never" />
                                <span>Никогда не покупали</span>
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="broadcast-include-expired" />
                                <span>Подписка истекла</span>
                            </label>
                        </div>
                        <div id="broadcast-tariff-options" class="audience-tariffs"></div>
                    </fieldset>
                    <p class="hint" id="broadcast-status">Создайте новую рассылку или выберите существующую.</p>
                    <div class="form-actions full">
                        <button class="btn primary" type="submit">Сохранить</button>
                        <button class="btn" type="button" id="broadcast-send" hidden>Отправить</button>
                        <button class="btn subtle" type="button" id="broadcast-edit-sent" hidden>Обновить текст</button>
                    </div>
                </form>
            </div>
        </section>

        <section class="card" id="promos-section">
            <header class="section-header">
                <div>
                    <h2>Промокоды</h2>
                    <p class="section-subtitle">Предлагайте скидки или дополнительные дни подписки.</p>
                </div>
                <button class="btn primary" type="submit" form="promo-form">Сохранить промокод</button>
            </header>

            <div class="promo-layout">
                <div class="promo-list">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>Скидка</th>
                                <th>Доп. дни</th>
                                <th>Использовано</th>
                                <th>Действует до</th>
                                <th class="actions"></th>
                            </tr>
                        </thead>
                        <tbody id="promo-table-body"></tbody>
                    </table>
                </div>
                <form id="promo-form" class="form-grid">
                    <input type="hidden" id="promo-id" />
                    <div class="form-field full">
                        <label for="promo-code">Код</label>
                        <input type="text" id="promo-code" required />
                    </div>
                    <div class="form-field full">
                        <label for="promo-description">Описание</label>
                        <textarea id="promo-description" rows="2"></textarea>
                    </div>
                    <div class="form-field">
                        <label for="promo-discount">Скидка (%)</label>
                        <input type="number" id="promo-discount" min="0" max="100" value="0" />
                    </div>
                    <div class="form-field">
                        <label for="promo-free-days">Бесплатные дни</label>
                        <input type="number" id="promo-free-days" min="0" value="0" />
                    </div>
                    <div class="form-field">
                        <label for="promo-max-uses">Максимум использований</label>
                        <input type="number" id="promo-max-uses" min="0" value="0" />
                    </div>
                    <label class="switch">
                        <span>Активен</span>
                        <input type="checkbox" id="promo-active" checked />
                        <span class="slider"></span>
                    </label>
                    <div class="form-field">
                        <label class="checkbox">
                            <input type="checkbox" id="promo-no-expiry" checked />
                            <span>Без срока действия</span>
                        </label>
                    </div>
                    <div class="form-field">
                        <label for="promo-expiry">Дата окончания</label>
                        <input type="date" id="promo-expiry" disabled />
                    </div>
                </form>
            </div>
        </section>

        <section class="card" id="conversations-section">
            <header class="section-header">
                <div>
                    <h2>Диалоги с пользователями</h2>
                    <p class="section-subtitle">Отвечайте на обращения прямо из панели управления.</p>
                </div>
                <button class="btn" type="button" id="refresh-conversations">Обновить</button>
            </header>

            <div class="conversation-layout">
                <aside class="conversation-sidebar" id="conversation-list"></aside>
                <div class="conversation-content">
                    <header class="conversation-header" id="conversation-header">Выберите пользователя</header>
                    <div class="conversation-empty" id="conversation-empty">
                        <p class="hint">Сообщения пользователя появятся здесь, когда вы выберете диалог.</p>
                    </div>
                    <div class="conversation-messages" id="conversation-messages"></div>
                    <form id="conversation-reply-form" class="reply-form disabled">
                        <textarea id="conversation-reply" rows="3" placeholder="Введите ответ" required></textarea>
                        <div class="form-actions">
                            <button class="btn primary" type="submit">Отправить</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <script src="{{.BASE_URL}}assets/js/telegram.js" type="module"></script>
</body>
</html>
